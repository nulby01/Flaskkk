import boto3
from werkzeug.utils import secure_filename

# Konfigurasi AWS S3
s3 = boto3.client('s3')
BUCKET_NAME = 'your-s3-bucket-name'

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route('/challenge/<int:challenge_id>', methods=['GET', 'POST'])
def challenge_detail(challenge_id):
    # Ambil file yang diupload
    file = request.files['file']
    if file and allowed_file(file.filename):
        filename = secure_filename(file.filename)
        file_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)

        # Simpan ke S3
        s3.upload_fileobj(file, BUCKET_NAME, filename)

        # Ambil URL file dari S3
        image_url = f"https://{BUCKET_NAME}.s3.amazonaws.com/{filename}"

        # Menyimpan data upload
        upload_data = {
            'challenge_title': challenge['title'],
            'response': request.form.get('response', ''),
            'image_url': image_url
        }
        UPLOADS.append(upload_data)
        flash(f"Tantangan '{challenge['title']}' berhasil diikuti! Foto diunggah ke S3.", 'success')
        return redirect(url_for('challenge_uploads'))
    else:
        flash("Gagal mengunggah file. Pastikan formatnya adalah PNG, JPG, atau JPEG.", 'error')
